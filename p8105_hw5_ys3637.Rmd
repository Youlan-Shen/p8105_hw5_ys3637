---
title: "p8105_hw5_ys3637"
author: "Youlan Shen"
date: "2022-11-16"
output: github_document
---
## Set up

```{r}
# library all packages that we need at the beginning
library(tidyverse)
library(ggridges)
library(patchwork)

# default set up
theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 2

```{r}
# read in data from CSV file
homicide_data <- read_csv("Data/Problem_2_data/homicide-data.csv")
# show the first several lines of the original data
homicide_data
```

This dataset contains `r nrow(homicide_data)` rows and `r ncol(homicide_data)` columns, while each row showing a homicide case in 50 large U.S. cities over the past decade. Variables include uid (the case id), reported_date(date the case reported), victim_last, victim_first (victim last and first name), victim_age, victim_sex, city, state, lat (latitude), lon (longitude), and disposition (if the case is closed or open, or closed with arrest or not). There are total `r nrow(homicide_data)` cases, with each row describing case date, location, victim information, and disposition information.

* Then, to create a city_state variable, and summarize within cities to obtain the total number of homicides and the number of unsolved homicides.

```{r}
# Create a city_state variable
homicide_data <- homicide_data %>% 
  janitor::clean_names() %>% 
  mutate(city_state = str_c(city, ", ", state))
# show it
homicide_data %>% 
  select(uid, city, state, city_state)
# summarize
homicide_data_summary <- homicide_data %>% 
  mutate(unsolved = ifelse(disposition == "Closed by arrest", FALSE, TRUE)) %>% 
  group_by(city_state) %>% 
  summarize(n_homicides = n(),
            n_unsolved = sum(unsolved))
homicide_data_summary
```

* For city Baltimore, MD, estimate the proportion of unsolved homicides, save as an R object and use broom::tidy, and pull out the result.

```{r}
# apply the prop test to the Baltimore, MD
prop_test_Bal_MD <- homicide_data_summary %>% 
  filter(city_state == "Baltimore, MD") %>% 
  mutate(prop_test = map2(n_unsolved, n_homicides, ~ prop.test(.x, .y) %>% 
                          broom::tidy())) %>% 
  select(prop_test) %>% 
  unnest()
# pull the result
prop_test_Bal_MD[c("estimate", "conf.low", "conf.high")]
```

* Run the prop.test for each city

```{r}
# apply the prop test to each city
prop_test_each_city <- homicide_data_summary %>% 
  mutate(prop_test = map2(n_unsolved, n_homicides, ~ prop.test(.x, .y) %>% 
                          broom::tidy())) %>% 
  unnest()
# select and tidy the result
prop_test_each_city %>% 
  select(city_state, estimate, conf.low, conf.high)
```

* Create a plot that shows the estimates and CIs for each city

```{r}
each_city_estimate <- prop_test_each_city %>% 
  select(city_state, estimate, conf.low, conf.high)
each_city_estimate %>% 
  ggplot(aes(x = fct_reorder(city_state, estimate, max), y = estimate, color = city_state)) + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  labs(
    title = "Estimate Homicide Propotion And CI For Each City",
    x = "City And State",
    y = "Estimate Homicide Prop and CI"
  )
```










